{% extends 'article.html' %}

{% block title %}Areas{% endblock %}

{% block article_header %}
<h1 class="article-header__headline">Results</h1>
<p class="article-header__byline">Luke Kavanagh</p>
<p class="article-header__dateline">Today</p>
{% endblock %}

{% block article_body %}
<p>Casting off stifling uniforms is something of a theme of Sir Stephen’s life. <a href="#">For most of his career</a>, he was a high-flying diplomat — culminating in a spell as Britain’s ambassador to the European Union in the 1990s and then as Tony Blair’s chief adviser on Europe. After retiring from the civil service in 2004, he became the senior policy adviser to Cormac Murphy-O’Connor, who was then Catholic archbishop of Westminster. But, in his early sixties, Sir Stephen decided that he no longer believed in God. Around the same time, he told his wife and adult son that he was gay. He is now a prominent advocate for gay rights and, in his own words, “a recovering Catholic”. In retirement, he has also shed his diplomatic neutrality and become a vocal advocate of continued British membership of the EU.</p>
<h2 class="article-body__subhead">This is a subhead</h2>
<p>Taken together, this all sounds like a major mid-life crisis. But the man sitting opposite me seems, physically and temperamentally, little changed from the calm diplomat I first met in Downing Street in 2000, when he briefed me about Britain’s negotiating position ahead of an EU summit in Nice. Now a young-looking 68, with closely-cropped grey hair and the same professorial spectacles, he remains the consummate mandarin — quick-witted and able to assess every angle of a question rapidly and with dry humour. Yet, behind the civil-service reserve, there was always more than met the eye to Sir Stephen Wall. Tony Blair wrote in his memoir, “Stephen was very professional and proficient . . . but underneath you could tell he was a riot of strong emotions, opinions and insights.”</p>
{% include "./group-slope.html" %}
<p>Taken together, this all sounds like a major mid-life crisis. But the man sitting opposite me seems, physically and temperamentally, little changed from the calm diplomat I first met in Downing Street in 2000, when he briefed me about Britain’s negotiating position ahead of an EU summit in Nice. Now a young-looking 68, with closely-cropped grey hair and the same professorial spectacles, he remains the consummate mandarin — quick-witted and able to assess every angle of a question rapidly and with dry humour.</p>
<figure class="figure o-grid-row" data-o-grid-colspan="12">
  <h3 class="article-body__subhead figure__title">This is a figure title</h3>
  <div class="figure__body">
  <p>Taken together, this all sounds like a major mid-life crisis. But the man sitting opposite me seems, physically and temperamentally, little changed from the calm diplomat I first met in Downing Street in 2000, when he briefed me about Britain’s negotiating position ahead of an EU summit in Nice. Now a young-looking 68, with closely-cropped grey hair and the same professorial spectacles.</p><p>he remains the consummate mandarin — quick-witted and able to assess every angle of a question rapidly and with dry humour. Yet, behind the civil-service reserve, there was always more than met the eye to Sir Stephen Wall. Tony Blair wrote in his memoir, “Stephen was very professional and proficient . . . but underneath you could tell he was a riot of strong emotions, opinions and insights.”</p>
  </div>
  <div class="figure__footer">
    <p>Some footer<p>
  </div>
</figure>
<h3 class="article-body__subhead">This is a subhead</h3>
<p>One of the more appealing traits of British civil servants is that they tend to be quite frugal. And the restaurant Sir Stephen has selected, Brasserie Zédel, is certainly not an extravagant choice, though it is fittingly European. Just off Piccadilly Circus, it is a huge, bustling basement decorated in 19th-century fin-de-siècle style with marble pillars, large mirrors, loads of gilt and tables pushed close together. All of the signs are in French (“toilette”, etc), which is arguably slightly pretentious but the couple next to us are speaking in French and this adds a touch of authenticity.</p>
{% endblock %}

{% block scripts %}

<script>

var d3 = require('d3');
var topojson = require('topojson');

document.addEventListener('o.DOMContentLoaded', function() {
  loaded();
});
</script>

<script>

  var mapURL = 'https://gist.githubusercontent.com/tomgp/8defaceafdce7a11cc7a/raw/991ac83d5a6905b7946fd49ce8bd71a1c986de4c/simplemap.topojson',
    dataURL = 'http://bertha.ig.ft.com/view/publish/ig/0AtxzL7xNk41FdHpvYkNPNlBnd1FXaUhFTXFUeG15VWc/basic,resultnow,details,predictions,coordinates',
    slopeAspect = 1;

  function loaded(){
    var graphics = document.graphics,

    width = 180,
    height = 100,
    margin = {top:5,left:2,bottom:5,right:40},
    slopeHeight = height - (margin.top + margin.bottom),
    slopeWidth = width - (margin.left + margin.right),
    slopeScale = d3.scale.linear()
      .domain([0,70])
      .range([slopeHeight,0]);

    var layout = graphics.slope.layout()
      .start(function(d){
        return d.resultnow;
      })
      .end(function(d){
        return d.resultprediction;
      });

    var SVGSlope = graphics.slope.svg()
      .width(slopeWidth)
      .radius(2)
      .endClass(function(d){
        return  ' end-point ' +d.data.party;
      })
      .startClass(function(d){
        return d.data.party + ' start-point'
      })
      .slopeClass(function(d){
        return d.data.party + ' slope'
      })
      .labelClass(function(d){
        return d.data.party + ' slope-label'
      })
      .label(function(d,i){
        if( d.data.winner ){
          return document.data.partyShortNames[d.data.party];
        }
      })
      .scale(slopeScale);

      function status(response) {
        if (response.status >= 200 && response.status < 300) {
          return Promise.resolve(response)
        } else {
          return Promise.reject(new Error(response.statusText))
        }
      }

      function toJson(response) {
        return response.json();
      }

      Promise.all([
        fetch(dataURL).then(status).then(toJson),
        fetch(mapURL).then(status).then(toJson),
      ]).then(function onData(responses) {
        gotData(undefined, responses[0], responses[1]);
        redrawSlopes();
      });

      function gotData(error, data, map){

        var groups = document.data.processForecastData(data);
        console.log(groups)
        var divs = d3.select('#slope-groups')
          .selectAll('div.group')
          .data(groups)
          .enter()
            .append('div')  //class="figure constituency-group constituency-group--slope o-grid-row" data-o-grid-colspan="12"
            .attr({
              'class':'figure constituency-group constituency-group--slope o-grid-row',
              'data-o-grid-colspan':12
            });

        divs.append('h2')
          .attr('class','article-body__subhead figure__title')
          .text(function(d){return d.headline; });

        var overview = divs.append('div')
          .attr({'data-o-grid-colspan':'12 S4 M3 L2'})
          .append('div')
            .attr({'class':'o-grid-row constituency-group__details'});

        overview.call(document.tables.forecastSummary);
        overview.each(function(g,i){
          var locator = graphics.constituencyLocator()
            .map(map)
            .locations(g.constituencies);

          d3.select(this).call(locator);
        });
        divs.call(groupContainer);
      };

      function groupContainer(g){
        g = g.append('div')
          .attr({'data-o-grid-colspan':'12 S8 M9 L10'})
            .append('div')
              .attr({'class':'o-grid-row'});


        var container = g.selectAll('div.constituency').data(function(d){
          return d.constituencies;
        }).enter()
          .append('div').attr({
            'class':'constituency-group__slope',
            'data-o-grid-colspan':'4 M3 L2 XL2'
          })

        divs = container.append('div').attr({
            'class':'constituency-group__slope-graphic'
          });

        container.append('div')
          .attr({
            'class':'constituency-group__constituency-name'
          }).text(function(d){
            return d.name;
          });

        divs.append('svg').attr({
          class:'slope-chart',
          'data-constituency':function(d){ return d.id; },
          viewBox:'0 0 ' + width + ' ' + height + '',
          preserveAspectRatio:'xMinYMid meet',
          width:width,
          height:height
        }).append('g').attr({
          'transform':'translate(' + margin.left + ',' + margin.top + ')'
        }).each(function(d){
          d3.select(this).selectAll('g.slope')
          .data(layout(d.parties).sort(function (a,b){
            if(a.slopeEnd<b.slopeEnd) return -1
              if(a.slopeEnd>b.slopeEnd) return 1
                return 0;
              }))
              .call(SVGSlope)
        });


      }

    window.redrawSlopes = function(){
      //Resize the SVG
      console.log('hello!');
      var size = d3.select('.constituency-group__slope-graphic').node().getBoundingClientRect()

      slopeWidth = size.width - (margin.left + margin.right);
      slopeHeight = slopeWidth/slopeAspect;
      slopeScale.range([slopeHeight,0]);

      SVGSlope
        .width(slopeWidth)
        .scale(slopeScale)

      var chartSVGs = d3.selectAll('svg.slope-chart').each(function(d,i){
        var svg = d3.select(this);
        var slope = svg.selectAll('g.slope').call(SVGSlope.reposition);
        var w = slopeWidth + (margin.left+margin.right);
        var h = slopeHeight + (margin.top+margin.bottom);
        svg.attr({
          width:w,
          height:h,
          viewBox:'0 0 ' + w + ' ' + h + '',
        });
      });
    };
  };

</script>


{% endblock %}
